{% extends "layout.html" %}

{% block content %}
<h1>구매 관리</h1>

<!-- 구매 등록 폼 -->
<form method="POST" class="mb-4">
    <div class="row">
        <div class="col-md-3">
            <div class="form-group">
                <label for="product_id">제품 <span class="text-danger">*</span></label>
                <select class="form-control" id="product_id" name="product_id" required>
                    <option value="">제품을 선택하세요</option>
                    {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="supplier_id">구매처 <span class="text-danger">*</span></label>
                <select class="form-control" id="supplier_id" name="supplier_id" required>
                    <option value="">구매처를 선택하세요</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label for="quantity">수량 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label for="price">단가 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
            </div>
        </div>
        <div class="col-md-2">
            <label class="d-block">&nbsp;</label>
            <button type="submit" class="btn btn-primary">등록</button>
        </div>
    </div>
</form>

<!-- 구매 목록 -->
<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>날짜</th>
                <th>제품명</th>
                <th>구매처</th>
                <th>수량</th>
                <th>단가</th>
                <th>총액</th>
                <th>작업</th>
            </tr>
        </thead>
        <tbody>
            {% if purchases %}
                {% for purchase in purchases %}
                    <tr id="purchase-{{ purchase.id }}">
                        <td>{{ purchase.date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ products|selectattr('id', 'eq', purchase.product_id)|first|attr('name') }}</td>
                        <td>{{ suppliers|selectattr('id', 'eq', purchase.supplier_id)|first|attr('name') }}</td>
                        <td>{{ purchase.quantity }}</td>
                        <td>{{ "{:,.0f}".format(purchase.price) }}원</td>
                        <td>{{ "{:,.0f}".format(purchase.quantity * purchase.price) }}원</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-btn" 
                                    data-id="{{ purchase.id }}"
                                    onclick="deletePurchase({{ purchase.id }})">
                                삭제
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center">구매 내역이 없습니다.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
function deletePurchase(id) {
    if (confirm('정말 이 구매 내역을 삭제하시겠습니까?')) {
        fetch(`/purchase/delete/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '삭제 중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            alert('삭제 중 오류가 발생했습니다.');
        });
    }
}

// 숫자 입력 필드에 대한 유효성 검사
document.getElementById('quantity').addEventListener('input', function() {
    if (this.value < 1) {
        this.value = 1;
    }
});

document.getElementById('price').addEventListener('input', function() {
    if (this.value < 0) {
        this.value = 0;
    }
});
</script>
{% endblock %} 